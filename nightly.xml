<?xml version="1.0"?>
<project name="nant" default="nightly">
    
    <script language="C#">
        <code>
			<![CDATA[
			public static void ScriptMain(Project project) {
				project.Properties.AddReadOnly("project.version", DateTime.Now.ToString("yyyyMMdd"));
			}
			]]>
		</code>
    </script>
    
    <property name="sf.net.ssh.server" value="shell1.sf.net"/>
    <property name="sf.net.build.path" value="/home/groups/n/na/nant/htdocs/builds"/>
    
    <include buildfile="nant.build"/>
    
    <target name="nightly" depends="package" description="Perform a 'nightly' package, and updates the version of NAnt that is executing.">
		
		<!-- copy the build up to sourceforge -->
		<scp file="${project.zip-path}" server="${sf.net.ssh.server}" path="${sf.net.build.path}"/>
		
		<!-- copy schema -->
		<scp file="${build.dir}/schema" server="${sf.net.ssh.server}" path="${sf.net.build.path}/..">
			<arg value="-r"/>
		</scp>		

		<!-- copy docs -->
		<scp file="${build.dir}/doc" server="${sf.net.ssh.server}" path="${sf.net.build.path}">
			<arg value="-r"/>
		</scp>		
		
		<!-- make sure files are readable -->
		<exec program="ssh">
			<arg value="${sf.net.ssh.server}"/>
			<arg value="chmod -R 755 ${sf.net.build.path}/*"/>
		</exec>
		
		<!-- Try to do the update -->
		<call target="UpdateRunningNAnt" failonerror="false"/>
    </target>

    <!-- Copies files to the nant executing dir. -->
    <target name="UpdateRunningNAnt">
        <copy todir="${nant.location}" overwrite="true">
            <fileset basedir="${build.dir}/bin/">
                <includes name="NAnt*" />
                
                <excludes name="*Test*" />
                <excludes name="${nant.console.name}.xml" /> 
                <excludes name="NAnt.exe" />
            </fileset>
        </copy>
    </target>
</project>