<?xml version="1.0" ?>
<project name="nant" default="nightly">
    <!-- set build.date property to current date in format yyyyMMdd -->
    <tstamp property="build.date" pattern="yyyyMMdd" />
    <property name="sf.net.ssh.server" value="shell1.sf.net" />
    <property name="sf.net.web.path" value="/home/groups/n/na/nant/htdocs" />
    <!-- retrieve system information and environment variables -->
    <sysinfo />
    <!-- setup property that holds partial path to be used by scp -->
    <property name="serverpart" value="${sys.env.USERNAME}@${sf.net.ssh.server}:${sf.net.web.path}" />
    <!-- include master build file -->
    <include buildfile="nant.build" />
    <!-- Perform a 'nightly' build, and install NAnt to install.dir -->
    <target name="nightly" depends="set-net-1.0-framework-configuration, package, deploy-sf, install" description="Perform a 'nightly' package, and installs NAnt." />
    <!-- deploy content to sourceforge -->
    <target name="deploy-sf" depends="deploy-zip-sf, deploy-schema-sf, deploy-help-sf, deploy-web-sf, deploy-nightly-web-sf" />
    <!-- copy the zipped nighly build to sourceforge -->
    <target name="deploy-zip-sf" depends="set-net-1.0-framework-configuration, package">
        <regex input="${project.zip-path}" pattern="^(?'execpath'.*(\\|/)|(/|\\))(?'execfilename'.*)$" />
        <!-- determine filename of distribution package on sf.net -->
        <property name="deploy.zip.file" value="${project.name}-${project.version}-${build.date}.zip" />
        <!-- make sure the directory tree exists -->
        <exec program="ssh">
            <arg value="${sf.net.ssh.server}" />
            <arg value="mkdir --mode=775 --parents ${sf.net.web.path}/nightly/builds" />
        </exec>
        <!-- copy the build to sourceforge -->
        <exec workingdir="${execpath}" program="scp">
            <arg value="${execfilename}" />
            <arg value="${serverpart}/nightly/builds/${deploy.zip.file}" />
        </exec>
        <echo message="Copied nightly build over to SF.Net" />
        <!-- make sure permissions are set right -->
        <exec program="ssh">
            <arg value="${sf.net.ssh.server}" />
            <arg value="chmod 775 ${sf.net.web.path}/nightly/builds/${deploy.zip.file}" />
        </exec>
        <!-- make sure group is set right -->
        <exec program="ssh">
            <arg value="${sf.net.ssh.server}" />
            <arg value="chgrp nant ${sf.net.web.path}/nightly/builds/${deploy.zip.file}" />
        </exec>
    </target>
    <!-- copy schema to sourceforge -->
    <target name="deploy-schema-sf" depends="set-net-1.0-framework-configuration, package">
        <!-- determine filename of schema on sf.net -->
        <property name="deploy.schema.file" value="${project.name}-${project.version}-${build.date}.xsd" />
        <!-- make sure the directory tree exists -->
        <exec program="ssh">
            <arg value="${sf.net.ssh.server}" />
            <arg value="mkdir --mode=775 --parents ${sf.net.web.path}/nightly/schema" />
        </exec>
        <!-- copy the schema file to sourceforge (using compression) -->
        <exec workingdir="${build.dir}/schema" program="scp">
            <arg value="-C" />
            <arg value="${project.name}-${project.version}.xsd" />
            <arg value="${serverpart}/nightly/schema/${deploy.schema.file}" />
        </exec>
        <echo message="Copied schema over to SF.Net" />
        <!-- make sure permissions are set right -->
        <exec program="ssh">
            <arg value="${sf.net.ssh.server}" />
            <arg value="chmod 775 ${sf.net.web.path}/nightly/schema/${deploy.schema.file}" />
        </exec>
        <!-- make sure group is set right -->
        <exec program="ssh">
            <arg value="${sf.net.ssh.server}" />
            <arg value="chgrp nant ${sf.net.web.path}/nightly/schema/${deploy.schema.file}" />
        </exec>
    </target>
    <!-- copy help to sourceforge -->
    <target name="deploy-help-sf" depends="set-net-1.0-framework-configuration, package">
        <!-- make sure the directory tree exists -->
        <exec program="ssh">
            <arg value="${sf.net.ssh.server}" />
            <arg value="mkdir --mode=775 --parents ${sf.net.web.path}/nightly/help" />
        </exec>
        <!-- try to remove existing files and directories -->
        <exec program="ssh" failonerror="false">
            <arg value="${sf.net.ssh.server}" />
            <arg value="rm -R --force ${sf.net.web.path}/nightly/help/*" />
        </exec>
        <!-- copy the help to sourceforge (using compression) -->
        <exec workingdir="${build.dir}/doc/help" program="scp">
            <arg value="-r" />
            <arg value="-C" />
            <arg value="*" />
            <arg value="${serverpart}/nightly/help" />
        </exec>
        <echo message="Copied docs over to SF.Net" />
        <!-- make sure permissions are set right -->
        <exec program="ssh" failonerror="false">
            <arg value="${sf.net.ssh.server}" />
            <arg value="chmod -R 775 ${sf.net.web.path}/nightly/help" />
        </exec>
        <!-- make sure group is set right -->
        <exec program="ssh">
            <arg value="${sf.net.ssh.server}" />
            <arg value="chgrp -R nant ${sf.net.web.path}/nightly/help" />
        </exec>
    </target>
    <!-- copy website to sourceforge -->
    <target name="deploy-web-sf" depends="set-net-1.0-framework-configuration, package">
        <!-- make sure the directory tree exists -->
        <exec program="ssh">
            <arg value="${sf.net.ssh.server}" />
            <arg value="mkdir --mode=775 --parents ${sf.net.web.path}" />
        </exec>
        <!-- try to remove existing files -->
        <exec program="ssh" failonerror="false">
            <arg value="${sf.net.ssh.server}" />
            <arg value="find ${sf.net.web.path} -maxdepth 1 -type f -exec rm --force {} \;" />
        </exec>
        <!-- copy html files for website to sourceforge (using compression) -->
        <exec workingdir="${build.dir}/doc" program="scp">
            <arg value="-C" />
            <arg value="*.html" />
            <arg value="${serverpart}" />
        </exec>
        <!-- copy images for website to sourceforge (using compression) -->
        <exec workingdir="${build.dir}/doc" program="scp">
            <arg value="-C" />
            <arg value="*.gif" />
            <arg value="${serverpart}" />
        </exec>
        <!-- copy stylesheet for website to sourceforge (using compression) -->
        <exec workingdir="${build.dir}/doc" program="scp">
            <arg value="-C" />
            <arg value="style.css" />
            <arg value="${serverpart}" />
        </exec>
        <!-- copy logo's for website to sourceforge (using compression) -->
        <exec workingdir="${build.dir}/doc" program="scp">
            <arg value="-C" />
            <arg value="logo.*" />
            <arg value="${serverpart}" />
        </exec>
        <echo message="Copied website over to SF.Net" />
        <!-- make sure permissions are set right -->
        <exec program="ssh" failonerror="false">
            <arg value="${sf.net.ssh.server}" />
            <arg value="find ${sf.net.web.path} -maxdepth 1 -type f -exec chmod 775 {} \;" />
        </exec>
        <!-- make sure group is set right -->
        <exec program="ssh">
            <arg value="${sf.net.ssh.server}" />
            <arg value="find ${sf.net.web.path} -maxdepth 1 -type f -exec chgrp nant {} \;" />
        </exec>
    </target>
    <!-- copy nightly website to sourceforge -->
    <target name="deploy-nightly-web-sf" depends="set-net-1.0-framework-configuration, package">
        <!-- make sure the directory tree exists -->
        <exec program="ssh">
            <arg value="${sf.net.ssh.server}" />
            <arg value="mkdir --mode=775 --parents ${sf.net.web.path}/nightly" />
        </exec>
        <!-- try to remove existing files -->
        <exec program="ssh" failonerror="false">
            <arg value="${sf.net.ssh.server}" />
            <arg value="find ${sf.net.web.path}/nightly -maxdepth 1 -type f -exec rm --force {} \;" />
        </exec>
        <!-- copy html files for website to sourceforge (using compression) -->
        <exec workingdir="${build.dir}/doc" program="scp">
            <arg value="-C" />
            <arg value="*.html" />
            <arg value="${serverpart}/nightly" />
        </exec>
        <!-- copy images for website to sourceforge (using compression) -->
        <exec workingdir="${build.dir}/doc" program="scp">
            <arg value="-C" />
            <arg value="*.gif" />
            <arg value="${serverpart}/nightly" />
        </exec>
        <!-- copy stylesheet for website to sourceforge (using compression) -->
        <exec workingdir="${build.dir}/doc" program="scp">
            <arg value="-C" />
            <arg value="style.css" />
            <arg value="${serverpart}/nightly" />
        </exec>
        <!-- copy logo's for website to sourceforge (using compression) -->
        <exec workingdir="${build.dir}/doc" program="scp">
            <arg value="-C" />
            <arg value="logo.*" />
            <arg value="${serverpart}/nightly" />
        </exec>
        <echo message="Copied website over to SF.Net" />
        <!-- make sure permissions are set right -->
        <exec program="ssh" failonerror="false">
            <arg value="${sf.net.ssh.server}" />
            <arg value="find ${sf.net.web.path}/nightly -maxdepth 1 -type f -exec chmod 775 {} \;" />
        </exec>
        <!-- make sure group is set right -->
        <exec program="ssh">
            <arg value="${sf.net.ssh.server}" />
            <arg value="find ${sf.net.web.path}/nightly -maxdepth 1 -type f -exec chgrp nant {} \;" />
        </exec>
    </target>
    <!-- copies NAnt to install dir -->
    <target name="install" depends="set-net-1.0-framework-configuration, package">
        <!-- ensure install directory was specified -->
        <if test="${not(property::exists('install.dir'))}">
            <fail>Please specify the directory to where NAnt should be installed on the commandline.</fail>
        </if>
        <!-- ensure the install directory exists -->
        <mkdir dir="${install.dir}" if="${not(directory::exists(install.dir))}"/>
        <!-- copy files to install directory -->
        <copy todir="${install.dir}" overwrite="true">
            <fileset basedir="${build.dir}">
                <includes name="**/**" />
            </fileset>
        </copy>
    </target>
</project>
