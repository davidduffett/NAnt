<?xml version="1.0"?>
<project name="nant" default="builld-official-release">
    <property name="sf.net.ssh.server" value="shell1.sf.net"/>
    <property name="sf.net.build.path" value="/home/groups/n/na/nant/htdocs"/>
    <!-- retrieve system information and environment variables -->
    <sysinfo />
    <!-- setup property that holds partial path to be used by scp -->
    <property name="serverpart" value="${sys.env.USERNAME}@${sf.net.ssh.server}:${sf.net.build.path}" />
    <!-- include master build file -->
    <include buildfile="nant.build"/>
    <!-- perform a 'release' package and upload to sf.net -->
    <target name="builld-official-release" description="Perform a 'release' package and uploads to sf.net">
        <!-- make sure NAnt is built using .NET Framework 1.0 -->
        <call target="set-net-1.0-runtime-configuration" />
        <!-- set active build configureation to 'release' -->
        <call target="release" />
        <!-- build NAnt -->
        <call target="package" />
        <!-- copy schema to sourceforge -->
        <call target="deploy-schema" />
        <!-- copy help to sourceforge -->
        <call target="deploy-help" />
        <!-- copy website to sourceforge -->
        <call target="deploy-website" />
    </target>
    <!-- copy schema to sourceforge -->
    <target name="deploy-schema" depends="set-net-1.0-runtime-configuration, release, package">
        <!-- make sure the directory tree exists -->
        <exec program="ssh">
            <arg value="${sf.net.ssh.server}" />
            <arg value="mkdir --mode=755 --parents ${sf.net.build.path}/schema" />
        </exec>
        <!-- copy schema file to sourceforge (using compression) -->
        <exec workingdir="${build.dir}/schema" program="scp">
            <arg value="-C" />
            <arg value="${project.name}-${project.version}.xsd" />
            <arg value="${serverpart}/schema" />
        </exec>
        <echo message="Copied schema over to SF.Net" />
        <!-- make sure permissions are set right -->
        <exec program="ssh">
            <arg value="${sf.net.ssh.server}" />
            <arg value="chmod 755 ${sf.net.build.path}/schema/${project.name}-${project.version}.xsd" />
        </exec>
    </target>
    <!-- copy help to sourceforge -->
    <target name="deploy-help" depends="set-net-1.0-runtime-configuration, release, package">
        <!-- make sure the directory tree exists -->
        <exec program="ssh">
            <arg value="${sf.net.ssh.server}" />
            <arg value="mkdir --mode=755 --parents ${sf.net.build.path}/help" />
        </exec>
        <!-- try to remove existing files and directories -->
        <exec program="ssh" failonerror="false">
            <arg value="${sf.net.ssh.server}" />
            <arg value="rm -R --force ${sf.net.build.path}/help/*" />
        </exec>
        <!-- copy help to sourceforge (using compression) -->
        <exec workingdir="${build.dir}/doc/help" program="scp">
            <arg value="-r" />
            <arg value="-C" />
            <arg value="*" />
            <arg value="${serverpart}/help" />
        </exec>
        <echo message="Copied docs over to SF.Net" />
        <!-- make sure permissions are set right -->
        <exec program="ssh" failonerror="false">
            <arg value="${sf.net.ssh.server}" />
            <arg value="chmod -R 755 ${sf.net.build.path}/help" />
        </exec>
    </target>
    <!-- copy website to sourceforge -->
    <target name="deploy-website" depends="set-net-1.0-runtime-configuration, release, package">
        <!-- make sure the directory tree exists -->
        <exec program="ssh">
            <arg value="${sf.net.ssh.server}" />
            <arg value="mkdir --mode=755 --parents ${sf.net.build.path}" />
        </exec>
        <!-- try to remove existing files -->
        <exec program="ssh" failonerror="false">
            <arg value="${sf.net.ssh.server}" />
            <arg value="rm --force ${sf.net.build.path}/*" />
        </exec>
        <!-- copy html files for website to sourceforge (using compression) -->
        <exec workingdir="${build.dir}/doc" program="scp">
            <arg value="-C" />
            <arg value="*.html" />
            <arg value="${serverpart}" />
        </exec>
        <!-- copy images for website to sourceforge (using compression) -->
        <exec workingdir="${build.dir}/doc" program="scp">
            <arg value="-C" />
            <arg value="*.gif" />
            <arg value="${serverpart}" />
        </exec>
        <!-- copy stylesheet for website to sourceforge (using compression) -->
        <exec workingdir="${build.dir}/doc" program="scp">
            <arg value="-C" />
            <arg value="style.css" />
            <arg value="${serverpart}" />
        </exec>
        <!-- copy logo's for website to sourceforge (using compression) -->
        <exec workingdir="${build.dir}/doc" program="scp">
            <arg value="-C" />
            <arg value="logo.*" />
            <arg value="${serverpart}" />
        </exec>
        <echo message="Copied website over to SF.Net" />
        <!-- make sure permissions are set right -->
        <exec program="ssh" failonerror="false">
            <arg value="${sf.net.ssh.server}" />
            <arg value="chmod 755 ${sf.net.build.path}/*" />
        </exec>
    </target>
</project>
